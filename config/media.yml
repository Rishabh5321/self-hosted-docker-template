- name: Media
  columns:
      - size: small
        widgets:
            - type: custom-api
              title: qBittorrent
              cache: 10s
              options:
                  view: "detailed" # "basic" or "detailed"
                  mode: "upload" # "default" or "upload"
              subrequests:
                  transfer:
                      url: http://${QBITTORRENT_IP}/api/v2/transfer/info
                  seeding:
                      url: http://${QBITTORRENT_IP}/api/v2/torrents/info
                      parameters:
                          filter: seeding
                  leeching:
                      url: http://${QBITTORRENT_IP}/api/v2/torrents/info
                      parameters:
                          filter: downloading
              template: |
                  {{ $transfer := .Subrequest "transfer" }}
                  {{ $seeding := .Subrequest "seeding" }}
                  {{ $leeching := .Subrequest "leeching" }}

                  {{ if and (eq $transfer.Response.StatusCode 200) (eq $seeding.Response.StatusCode 200) (eq $leeching.Response.StatusCode 200) }}

                    {{ $isDetailed := eq (.Options.StringOr "view" "detailed") "detailed" }}
                    {{ $mode := .Options.StringOr "mode" "default" }}

                    {{ if $isDetailed }}
                    <!-- Detailed View -->
                    <div class="list" style="--list-gap: 15px;">
                      <div class="flex justify-between text-center">
                        <div>
                          {{ $dlSpeed := $transfer.JSON.Float "dl_info_speed" }}
                          {{ if eq $mode "upload" }}
                            <div class="color-highlight size-h3">{{ printf "%.1f MB/s" (div $dlSpeed 1000000.0) }}</div>
                          {{ else }}
                            {{ if lt $dlSpeed 1048576.0 }}
                              <div class="color-highlight size-h3">{{ printf "%.0f KiB/s" (div $dlSpeed 1024.0) }}</div>
                            {{ else }}
                              <div class="color-highlight size-h3">{{ printf "%.1f MiB/s" (div $dlSpeed 1048576.0) }}</div>
                            {{ end }}
                          {{ end }}
                          <div class="size-h6">DOWNLOADING</div>
                        </div>

                        {{ if eq $mode "upload" }}
                        <div>
                          {{ $ulSpeed := $transfer.JSON.Float "up_info_speed" }}
                          <div class="color-highlight size-h3">{{ printf "%.1f MB/s" (div $ulSpeed 1000000.0) }}</div>
                          <div class="size-h6">UPLOADING</div>
                        </div>
                        {{ end }}

                        <div>
                          <div class="color-highlight size-h3">{{ len ($seeding.JSON.Array "") }}</div>
                          <div class="size-h6">SEEDING</div>
                        </div>

                        {{ if eq $mode "default" }}
                        <div>
                          <div class="color-highlight size-h3">{{ len ($leeching.JSON.Array "") }}</div>
                          <div class="size-h6">LEECHING</div>
                        </div>
                        {{ end }}
                      </div>

                      <!-- Downloading list -->
                      {{ $downloadingTorrents := $leeching.JSON.Array "" }}
                      {{ if gt (len $downloadingTorrents) 0 }}
                        <div style="margin-top: 15px;">
                          <ul class="list collapsible-container" data-collapse-after="0" style="--list-gap: 15px;">
                            {{ range $t := $downloadingTorrents }}
                              {{ $state := $t.String "state" }}
                              {{ $icon := "?" }}
                              {{ if ge ($t.Int "completed") ($t.Int "size") }}{{ $icon = "✔" }}
                              {{ else if eq $state "downloading" "forcedDL" }}{{ $icon = "↓" }}
                              {{ else if eq $state "pausedDL" "stoppedDL" "pausedUP" "stalledDL" "stalledUP" "queuedDL" "queuedUP" }}{{ $icon = "❚❚" }}
                              {{ else if eq $state "error" "missingFiles" }}{{ $icon = "!" }}
                              {{ else if eq $state "checkingDL" "checkingUP" "allocating" }}{{ $icon = "…" }}
                              {{ else if eq $state "checkingResumeData" }}{{ $icon = "⟳" }}
                              {{ end }}

                              <li class="flex items-center" style="gap: 10px;">
                                <div class="size-h4" style="flex-shrink: 0;">{{ $icon }}</div>
                                <div style="flex-grow: 1; min-width: 0;">
                                  <div class="text-truncate color-highlight">{{ $t.String "name" }}</div>
                                  <div title="{{ $t.Float "progress" | mul 100 | printf "%.1f" }}%" style="background: rgba(128, 128, 128, 0.2); border-radius: 5px; height: 6px; margin-top: 5px; overflow: hidden;">
                                    <div style="width: {{ $t.Float "progress" | mul 100 }}%; background-color: var(--color-positive); height: 100%; border-radius: 5px;"></div>
                                  </div>
                                </div>
                                <div style="flex-shrink: 0; text-align: right; width: 80px;">
                                  {{ $dlSpeed := $t.Float "dlspeed" }}
                                  <div class="size-sm color-paragraph">
                                    {{ if eq $mode "upload" }}
                                      {{ if lt $dlSpeed 1000.0 }}--{{ else }}{{ printf "%.1f MB/s" (div $dlSpeed 1000000.0) }}{{ end }}
                                    {{ else }}
                                      {{ if lt $dlSpeed 1024.0 }}--{{ else if lt $dlSpeed 1048576.0 }}{{ printf "%.0f KiB/s" (div $dlSpeed 1024.0) }}{{ else }}{{ printf "%.1f MiB/s" (div $dlSpeed 1048576.0) }}{{ end }}
                                    {{ end }}
                                  </div>
                                  {{ $eta := $t.Int "eta" }}
                                  <div class="size-sm color-paragraph">
                                    {{ if eq $eta 8640000 }}∞
                                    {{ else if gt $eta 3600 }}{{ printf "%dh %dm" (div $eta 3600) (mod (div $eta 60) 60) }}
                                    {{ else if gt $eta 0 }}{{ printf "%dm" (div $eta 60) }}
                                    {{ else }}--{{ end }}
                                  </div>
                                </div>
                              </li>
                            {{ end }}
                          </ul>
                        </div>
                      {{ end }}

                      <!-- Seeding list -->
                      {{ if eq $mode "upload" }}
                        {{ $seedingTorrents := $seeding.JSON.Array "" }}
                        {{ if gt (len $seedingTorrents) 0 }}
                          <div style="margin-top: 20px;">
                            <ul class="list collapsible-container" data-collapse-after="0" style="--list-gap: 15px;">
                              {{ range $t := $seedingTorrents }}
                                {{ $state := $t.String "state" }}
                                {{ $icon := "↑" }}
                                {{ if eq $state "pausedUP" "stoppedUP" "stalledUP" "queuedUP" }}{{ $icon = "❚❚" }}
                                {{ else if eq $state "error" "missingFiles" }}{{ $icon = "!" }}
                                {{ else if eq $state "checkingUP" }}{{ $icon = "…" }}
                                {{ else if eq $state "checkingResumeData" }}{{ $icon = "⟳" }}
                                {{ end }}

                                <li class="flex items-center" style="gap: 10px;">
                                  <div class="size-h4" style="flex-shrink: 0;">{{ $icon }}</div>
                                  <div style="flex-grow: 1; min-width: 0;">
                                    <div class="text-truncate color-highlight">{{ $t.String "name" }}</div>
                                    <div class="size-sm color-paragraph">
                                      Ratio: {{ printf "%.2f" ($t.Float "ratio") }} |
                                      Size: {{ printf "%.1f GB" (div ($t.Float "size") 1073741824.0) }}
                                    </div>
                                  </div>
                                  <div style="flex-shrink: 0; text-align: right; width: 80px;">
                                    {{ $ulSpeed := $t.Float "upspeed" }}
                                    <div class="size-sm color-paragraph">
                                      {{ if lt $ulSpeed 1000.0 }}--{{ else }}{{ printf "%.1f MB/s" (div $ulSpeed 1000000.0) }}{{ end }}
                                    </div>
                                    <div class="size-sm color-paragraph">Upload</div>
                                  </div>
                                </li>
                              {{ end }}
                            </ul>
                          </div>
                        {{ end }}
                      {{ end }}

                    </div>

                    {{ else }}
                    <!-- Basic View -->
                    <div class="flex justify-between text-center">
                      <div>
                        {{ $dlSpeed := $transfer.JSON.Float "dl_info_speed" }}
                        <div class="color-highlight size-h3">{{ printf "%.1f MB/s" (div $dlSpeed 1000000.0) }}</div>
                        <div class="size-h6">DOWNLOADING</div>
                      </div>
                      {{ if eq $mode "upload" }}
                      <div>
                        {{ $ulSpeed := $transfer.JSON.Float "up_info_speed" }}
                        <div class="color-highlight size-h3">{{ printf "%.1f MB/s" (div $ulSpeed 1000000.0) }}</div>
                        <div class="size-h6">UPLOADING</div>
                      </div>
                      {{ end }}
                      <div>
                        <div class="color-highlight size-h3">{{ len ($seeding.JSON.Array "") }}</div>
                        <div class="size-h6">SEEDING</div>
                      </div>
                      {{ if eq $mode "default" }}
                      <div>
                        <div class="color-highlight size-h3">{{ len ($leeching.JSON.Array "") }}</div>
                        <div class="size-h6">LEECHING</div>
                      </div>
                      {{ end }}
                    </div>
                    {{ end }}

                  {{ else }}
                    <div class="color-negative text-center">
                      <p>Error fetching qBittorrent data.</p>
                      <p class="size-sm">Check URL and authentication bypass settings.</p>
                    </div>
                  {{ end }}
            - type: custom-api
              title: Prowlarr Indexers
              cache: 1m
              options:
                  url: "${PROWLARR_URL}"
                  base-url: ${PROWLARR_API_URL}
                  api-key: ${PROWLARR_KEY}
                  collapse-after: ${PROWLARR_COLLAPSE_AFTER}
              template: |
                  {{ $apiBaseUrl := .Options.StringOr "base-url" "" }}
                  {{ $key := .Options.StringOr "api-key" "" }}
                  {{ $url := .Options.StringOr "url" "" }}
                  {{ $collapseAfter := .Options.IntOr "collapse-after" 5 }}

                  {{ if or (eq $apiBaseUrl "") (eq $key "") (eq $url "") }}
                          <div class="widget-error-header">
                              <div class="color-negative size-h3">ERROR</div>
                              <svg class="widget-error-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z"></path>
                              </svg>
                            </div>
                            <p class="break-all">
                              Some options are not set or malformed
                                <table style="border-spacing: 1rem;">
                                  <tr>
                                    <td><strong>PROWLARR_URL & PROWLARR_API_URL</strong> <br/> should include http(s):// and port if needed</td>
                                  </tr>
                                  <tr>
                                    <td><strong>PROWLARR_KEY</strong> <br/> must be set (Settings > General > Security)</td>
                                  </tr>
                                </table>
                            </p>
                        {{ else }}

                          {{ $indexUrl := printf "%s/api/v1/indexer" $apiBaseUrl }}

                          {{ $indexData := newRequest $indexUrl
                            | withHeader "Accept" "application/json"
                            | withHeader "X-Api-Key" $key
                            | getResponse }}

                          {{ if eq $indexData.Response.StatusCode 200 }}
                            <style>
                              .prowlarr-indexers .prowlarr-index-item
                              {
                                align-items: center;
                              }
                              .prowlarr-indexers .prowlarr-index-item > span{
                                text-transform: capitalize;
                                background: var(--color-background);
                                padding: 0.2rem 0.75rem;
                                border: 1px solid var(--color-widget-content-border);
                                border-radius: var(--border-radius);
                                font-size: var(--font-size-tiny);
                              }
                            </style>

                            <ul class="prowlarr-indexers list list-gap-10 collapsible-container" data-collapse-after="{{ $collapseAfter }}">

                              {{ range $indexData.JSON.Array "" }}
                                {{ $isEnabled := .String "enable" }}

                                <li class="flex items-center gap-12 prowlarr-index-item">
                                  <a href="{{ $url }}" target="_blank" class="size-title-dynamic color-highlight text-truncate block grow">{{ .String "name" }}</a>
                                  <span>{{ .String "privacy" }}</span>
                                  {{ if eq $isEnabled "true" }}
                                    <div class="margin-left-auto shrink-0" data-popover-type="text" data-popover-position="above" data-popover-text="Enabled" aria-label="Enabled">
                                      <div class="monitor-site-status-icon-compact" title="Enabled">
                                        <svg fill="var(--color-positive)" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                          <path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Zm3.857-9.809a.75.75 0 0 0-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 1 0-1.06 1.061l2.5 2.5a.75.75 0 0 0 1.137-.089l4-5.5Z" clip-rule="evenodd"></path>
                                        </svg>
                                      </div>
                                    </div>
                                  {{ else }}
                                    <div class="margin-left-auto shrink-0" data-popover-type="text" data-popover-position="above" data-popover-text="Disabled" aria-label="Disabled">
                                      <div class="monitor-site-status-icon-compact" title="Disabled">
                                        <svg fill="var(--color-negative)" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                                          <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495ZM10 5a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 10 5Zm0 9a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" clip-rule="evenodd"></path>
                                        </svg>
                                      </div>
                                    </div>
                                  {{ end }}

                                </li>
                              {{ end }}

                            </ul>
                          {{ else }}
                            <p>Failed to fetch data (Status: {{ $indexData.Response.StatusCode }})</p>
                          {{ end }}

                        {{ end }}
            - type: custom-api
              title: "Jellyfin/Emby Stats"
              base-url: ${JELLYFIN_URL}
              options:
                  url: ${JELLYFIN_URL}
                  key: ${JELLYFIN_API_KEY}

              template: |
                  {{ $url := .Options.StringOr "url" "" }}
                  {{ $key := .Options.StringOr "key" "" }}

                              {{- if or (eq $url "") (eq $key "") -}}

                                <p>Error: The URL or API Key was not configured in the widget options.</p>

                              {{- else -}}

                                {{- $requestUrl := printf "%s/emby/Items/Counts?api_key=%s" $url $key -}}
                                {{- $jellyfinData := newRequest $requestUrl | getResponse -}}

                                {{- if eq $jellyfinData.Response.StatusCode 200 -}}
                                  <div class="flex flex-column gap-5">
                                    <div class="flex justify-between text-center">

                                      <div>
                                        <div class="color-highlight size-h3">{{ $jellyfinData.JSON.Int "MovieCount" | formatNumber }}</div>
                                        <div class="size-h5 uppercase">Movies</div>
                                      </div>

                                      <div>
                                        <div class="color-highlight size-h3">{{ $jellyfinData.JSON.Int "SeriesCount" | formatNumber }}</div>
                                        <div class="size-h5 uppercase">TV Shows</div>
                                      </div>

                                      <div>
                                        <div class="color-highlight size-h3">{{ $jellyfinData.JSON.Int "EpisodeCount" | formatNumber }}</div>
                                        <div class="size-h5 uppercase">Episodes</div>
                                      </div>

                                      <div>
                                        <div class="color-highlight size-h3">{{ $jellyfinData.JSON.Int "SongCount" | formatNumber }}</div>
                                        <div class="size-h5 uppercase">Songs</div>
                                      </div>

                                    </div>
                                  </div>
                                {{- else -}}
                                  <p>Failed: {{ $jellyfinData.Response.Status }}</p>
                                {{- end -}}
                              {{- end -}}
      - size: full
        widgets:
            - type: custom-api
              title: Trakt
              cache: 30m
              url: https://api.trakt.tv/users/${TRAKT_USERNAME}/history
              parameters:
                  type: shows,movies
                  limit: 10
                  sort: watched_at,desc
              headers:
                  trakt-api-key: ${TRAKT_API_KEY}
                  trakt-api-version: 2
                  User-Agent: GlanceWidget
                  Accept: application/json
              template: |
                  {{/* USER VARIABLES BEGIN */}}
                  {{/* Number of items to show before SHOW MORE appears */}}
                  {{ $collapseAfter := 3 }}

                  {{/* Set to false to hide S#E# episode numbers on TV Shows */}}
                  {{ $showEpisodeNumber := true }}

                  {{/* Set to true to show year on Movies */}}
                  {{ $showMovieYear := false }}

                  {{/* Set to true to show year on TV Shows */}}
                  {{ $showTVYear := false }}
                  {{/* USER VARIABLES END */}}

                  <ul class="list list-gap-10 collapsible-container" data-collapse-after="{{ $collapseAfter }}">
                  {{ range .JSON.Array "" }}
                    {{ $tmdbID := "" }}
                    {{ $tmdbData := "" }}
                    {{ $mediaType := .String "type" }}
                    {{ $tmdbPageUrl := "" }}
                    {{ $imageUrlBase := "https://image.tmdb.org/t/p/w185" }}
                    {{ $posterPath := "" }}
                    {{ $posterUrl := "" }}
                    {{ if eq $mediaType "episode" }}
                      {{ $tmdbID = .String "show.ids.tmdb" }}
                      {{
                        $tmdbData = newRequest (concat "https://api.themoviedb.org/3/tv/" $tmdbID "?api_key=" "${TMDB_API_KEY}")
                        | withHeader "Accept" "application/json"
                        | getResponse
                      }}
                      {{ $tmdbPageUrl = concat "https://www.themoviedb.org/tv/" $tmdbID }}
                    {{ else }}
                      {{ $tmdbID = .String "movie.ids.tmdb" }}
                      {{
                        $tmdbData = newRequest (concat "https://api.themoviedb.org/3/movie/" $tmdbID "?api_key=" "${TMDB_API_KEY}")
                        | withHeader "Accept" "application/json"
                        | getResponse
                      }}
                      {{ $tmdbPageUrl = concat "https://www.themoviedb.org/movie/" $tmdbID }}
                    {{ end }}
                    {{ if $tmdbData }}
                      {{ $posterPath = $tmdbData.JSON.String "poster_path" }}
                      {{ if $posterPath }}
                        {{ $posterUrl = concat $imageUrlBase $posterPath }}
                      {{ end }}
                    {{ end }}

                    <li class="flex items-center gap-10">
                      <a href={{ $tmdbPageUrl }} target="_blank">
                        <img src='{{ $posterUrl }}' alt="" style="border-radius: 5px; min-width: 5rem; max-width: 5rem;" class="card">
                      </a>
                      <div class="flex-1">
                        <a href={{ $tmdbPageUrl }} target="_blank">
                          <p class="color-positive size-h5">{{ .String "show.title" }}{{ .String "movie.title" }}
                          {{ if eq (.String "type") "movie" }}
                            {{ if $showMovieYear }}
                              ({{ .String "movie.year" }})
                            {{ end }}
                          {{ else }}
                            {{ if $showTVYear }}
                              ({{ .String "show.year" }})
                            {{ end }}
                          {{ end }}
                          </p>
                        </a>
                        <a href={{ $tmdbPageUrl }} target="_blank">
                          {{ if eq (.String "type") "episode" }}
                          <p class="size-h5">
                          {{ if $showEpisodeNumber }}
                            (S{{ .String "episode.season" }}E{{ .String "episode.number" }})
                          {{ end }}
                          {{ .String "episode.title" }}
                          </p>
                          {{ end }}
                        </a>
                        <p class="size-h6">
                          <span class="color-subdue" {{ .String "watched_at" | parseRelativeTime "2006-01-02T15:04:05.000Z" }}></span>
                        </p>
                      </div>
                    </li>
                  {{ end }}
                  </ul>
            - type: custom-api
              title: Trending Media
              title-url: ${OVERSEERR_URL}/discover/trending # trending, movies, or tv
              url: ${OVERSEERR_URL}/api/v1/discover/trending # trending, movies, or tv
              cache: 15m
              headers:
                  accept: "application/json"
                  x-api-key: ${OVERSEERR_API_KEY}
              parameters:
                  language: "en" # this can be changed to other languages if desired
                  page: "1"
              options:
                  show-media-type: true # set to false to hide the "| TV" or "| Movie" suffix
                  show-media-desc: true # set to false to hide the media's summary
              template: |
                  {{ $showMediaType := .Options.BoolOr "show-media-type" true }}
                      {{ $showMediaDesc := .Options.BoolOr "show-media-desc" true }}

                      {{ if eq .Response.StatusCode 200 }}
                        {{ $items := .JSON.Array "results" }}
                        {{ if gt (len $items) 0 }}
                          <ul class="list list-gap-10 collapsible-container" data-collapse-after="5">
                          {{ range $items }}
                            <li class="flex items-start gap-10 thumbnail-container thumbnail-parent">
                              {{ $mediaType := .String "mediaType" }}
                              {{ $mediaTitle := "" }}
                              {{ $mediaTypeUpper := "" }}
                              {{ if eq $mediaType "movie" }} {{ $mediaTitle = .String "title" }} {{ $mediaTypeUpper = "Movie" }}{{ else }}{{ $mediaTitle = .String "name" }} {{ $mediaTypeUpper = "TV" }}{{ end }}
                              {{ $overseerrUrl := concat "${OVERSEERR_URL}" "/" $mediaType "/" ( .String "id" ) }}
                              {{ $tmdbUrl := concat "https://www.themoviedb.org" "/" $mediaType "/" ( .String "id" ) }}
                              <a href={{ $overseerrUrl }} target="_blank">
                              <img src={{ concat "https://image.tmdb.org/t/p/w300" (.String "posterPath") }} style="border-radius: 5px; min-width: 5rem; max-width: 5rem;" class="card">
                              </a>
                              <div class="flex-1" style="padding-right: 5px;">
                                <p class="color-positive size-h4 text-truncate-2-lines margin-top-5" title={{ $mediaTitle }}><a href={{ $overseerrUrl }} target="_blank">{{ $mediaTitle }}</p>
                                <p class="size-h4" title="TMDB Rating"><a href={{ $tmdbUrl }} target="_blank">TMDB: {{ mul (.Float "voteAverage") 10 | toInt }}% {{ if $showMediaType }}| {{ $mediaTypeUpper }}{{ end }}</a></p>
                                {{ if $showMediaDesc }}<p class="color-subdue size-h4 text-truncate-2-lines" title={{ .String "overview" }}>{{ .String "overview" }}</p>{{ end }}
                              </div>
                            </li>
                          {{ end }}
                          </ul>
                        {{ else }}
                          <details style="margin-top:0.5rem">
                            <summary> Raw JSON:</summary>
                            <pre stye="font-size:10px">
                        {{ (printf "%+v" .JSON) }}
                            </pre>
                          </details>
                        {{ end }}
                      {{ end }}
